{% extends "base.html" %}

{% block content %}
<div class="result-container">
    <div class="header-section">
        <a href="/" class="back-link">← Back to Workbench</a>
        <h1>
            {% if result.mode == 'exam' %}
            Admission Results (Official)
            {% else %}
            Practice Results (Draft Check)
            {% endif %}
        </h1>

        <div class="tweet-preview">
            <h3 class="label">The Tweet</h3>
            {% if tweet_url %}
            <p><a href="{{ tweet_url }}" target="_blank">{{ tweet_url }}</a></p>
            {% endif %}
            {% if tweet_text and tweet_text != "No text provided" %}
            <p class="tweet-text">{{ tweet_text }}</p>
            {% else %}
            <p class="tweet-text" style="color: var(--text-muted); font-style: italic;">
                Tweet text unavailable (rate limit exceeded). Please visit the URL above to view the tweet.
            </p>
            {% endif %}
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger">
        <span class="icon">⚠️</span> <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    {% if fixed_message %}
    <div class="alert alert-success">
        <span class="icon">✨</span> {{ fixed_message }}
    </div>
    {% endif %}

    <div class="score-card card">
        <div class="score-visual">
            {% if result.passed %}
            <div class="status-icon success">✓</div>
            {% else %}
            <div class="status-icon failure">✕</div>
            {% endif %}
        </div>

        <div class="score-details">
            {% if result.mode == 'exam' %}
            {% if result.passed %}
            <h2 class="status-success">Admission Granted</h2>
            <p>This note meets all criteria for Community Notes admission. It has been submitted!</p>
            {% else %}
            <h2 class="status-danger">Admission Denied</h2>
            <p>The note failed one or more checks. Use the Fixer to improve it.</p>
            {% endif %}
            {% else %}
            <!-- Practice Mode -->
            {% if result.passed %}
            <h2 class="status-success">Ready for Exam</h2>
            <p>Great job! This note has a high evaluation score. You can now submit it.</p>
            {% else %}
            <h2 class="status-danger">Needs Improvement</h2>
            <p>The evaluation score is too low. Use the Fixer to optimize it before submitting.</p>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <div class="metrics-section">
        <h2>
            {% if result.mode == 'exam' %}
            Official API Scores
            {% else %}
            {% if result.is_fallback %}
            Evaluation Scores (Simulated by AI)
            <span class="badge badge-warning" title="Official API unavailable">Fallback</span>
            {% else %}
            Evaluation Scores (Official)
            {% endif %}
            {% endif %}
        </h2>

        {% if result.is_fallback %}
        <div class="alert alert-warning" style="margin-bottom: 16px; font-size: 0.9em;">
            <span class="icon">⚠️</span>
            <strong>Note:</strong> Official evaluation endpoint failed. Using AI simulation to estimate score.
            <br>
            <small>Error: {{ result.error }}</small>
        </div>
        {% endif %}

        <div class="metrics-grid">
            <!-- UrlValidity -->
            <div
                class="card metric-card {{ 'passed' if result.scores.get('url_validity_score', 0) >= 0.95 else ('failed' if result.mode == 'exam' else 'pending') }}">
                <h3>UrlValidity</h3>
                {% if result.mode == 'exam' %}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="note-section">
        <h2>Current Note Draft</h2>
        <div class="card note-card">
            <div class="note-text">{{ note_text }}</div>
        </div>
    </div>

    <div class="actions-section" style="display: flex; gap: 16px; justify-content: center; margin-top: 32px;">
        {% if not result.passed %}
        <form action="/simulator/run" method="post" class="fixer-form">
            <input type="hidden" name="tweet_url" value="{{ tweet_url }}">
            <input type="hidden" name="tweet_text" value="{{ tweet_text }}">
            <input type="hidden" name="note_text" value="{{ note_text }}">
            <input type="hidden" name="fix_mode" value="true">
            <input type="hidden" name="action" value="check">
            <input type="hidden" name="failure_reasons" value="{{ result.failure_reasons|join(',') }}">

            <button type="submit" class="btn btn-primary btn-fix">
                <span class="icon">✨</span> Auto-Fix Issues ({{ result.failure_reasons|join(', ') }})
            </button>
        </form>
        {% endif %}

        {% if result.mode == 'practice' %}
        <form action="/simulator/run" method="post">
            <input type="hidden" name="tweet_url" value="{{ tweet_url }}">
            <input type="hidden" name="tweet_text" value="{{ tweet_text }}">
            <input type="hidden" name="note_text" value="{{ note_text }}">
            <input type="hidden" name="action" value="submit">

            <div class="tooltip-container">
                <button type="submit" class="btn btn-primary btn-submit" {% if not result.passed %}disabled{% endif %}>
                    Submit to Community Notes (Exam)
                </button>
                {% if not result.passed %}
                <span class="tooltip-text">Achieve High Evaluation Score to unlock Submission.</span>
                {% endif %}
            </div>
        </form>
        {% endif %}
    </div>
</div>

<style>
    /* Tooltip Styles */
    .tooltip-container {
        position: relative;
        display: inline-block;
    }

    .tooltip-text {
        visibility: hidden;
        width: 220px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        /* Position above */
        left: 50%;
        margin-left: -110px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 12px;
        pointer-events: none;
    }

    .tooltip-container:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

    /* Disabled button style wrapper to ensure hover works */
    .btn:disabled {
        pointer-events: auto;
        /* Allow hover on disabled button for tooltip */
    }

    .result-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .header-section {
        margin-bottom: 32px;
    }

    .back-link {
        display: inline-block;
        margin-bottom: 24px;
        font-size: 14px;
        font-weight: 500;
    }

    .tweet-preview {
        margin-top: 16px;
        padding: 24px;
        background: var(--bg-panel);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
    }

    .label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 8px;
    }

    .tweet-text {
        font-size: 18px;
        color: var(--text-main);
        margin: 0;
    }

    /* Score Card */
    .score-card {
        display: flex;
        align-items: center;
        gap: 32px;
        margin-bottom: 48px;
        padding: 32px;
    }

    .status-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        font-weight: bold;
    }

    .status-icon.success {
        background: rgba(45, 212, 191, 0.1);
        color: var(--accent-primary);
        border: 2px solid var(--accent-primary);
    }

    .status-icon.failure {
        background: rgba(244, 63, 94, 0.1);
        color: var(--accent-danger);
        border: 2px solid var(--accent-danger);
    }

    .score-details h2 {
        font-size: 28px;
        margin-bottom: 8px;
    }

    .status-success {
        color: var(--accent-primary);
    }

    .status-danger {
        color: var(--accent-danger);
    }

    /* Metrics Grid */
    .metrics-section {
        margin-bottom: 48px;
    }

    .metrics-section h2 {
        font-size: 20px;
        margin-bottom: 24px;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
    }

    .metric-card {
        padding: 24px;
        text-align: center;
        border-top: 4px solid transparent;
    }

    .metric-card.passed {
        border-top-color: var(--accent-primary);
    }

    .metric-card.failed {
        border-top-color: var(--accent-danger);
    }

    .metric-card h3 {
        font-size: 14px;
        color: var(--text-muted);
        margin-bottom: 16px;
    }

    .metric-score {
        font-size: 32px;
        font-weight: bold;
        font-family: var(--font-mono);
        margin-bottom: 16px;
    }

    .metric-meta {
        font-size: 12px;
        color: var(--text-muted);
        display: flex;
        justify-content: space-between;
        padding-top: 12px;
        border-top: 1px solid var(--border-subtle);
    }

    .metric-card.passed .status-text {
        color: var(--accent-primary);
        font-weight: bold;
    }

    .metric-card.failed .status-text {
        color: var(--accent-danger);
        font-weight: bold;
    }

    /* Note Section */
    .note-section {
        margin-bottom: 48px;
    }

    .note-card {
        padding: 24px;
        background: var(--bg-panel);
    }

    .note-text {
        font-size: 16px;
        line-height: 1.6;
        white-space: pre-wrap;
    }

    /* Fixer Section */
    .fixer-section {
        background: var(--bg-card);
        border: 1px solid var(--border-focus);
        border-radius: var(--radius-lg);
        padding: 32px;
        text-align: center;
        box-shadow: 0 0 40px rgba(59, 130, 246, 0.1);
    }

    .fixer-header {
        margin-bottom: 24px;
    }

    .btn-fix {
        min-width: 200px;
        height: 56px;
        font-size: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
    }

    .alert {
        padding: 16px 24px;
        border-radius: var(--radius-md);
        margin-bottom: 32px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .alert-success {
        background: rgba(45, 212, 191, 0.1);
        border: 1px solid var(--accent-primary);
        color: var(--accent-primary);
    }
</style>
{% endblock %}